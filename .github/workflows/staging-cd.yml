name: Continuous Staging

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types:
      - completed
jobs:
  deployment:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        services:
          [
            'organisation-registry-api',
            'organisation-registry-delegations',
            'organisation-registry-elasticsearch',
            'organisation-registry-kbomutations',
            'organisation-registry-reporting',
            'organisation-registry-scheduler',
            'organisation-registry-ui',
            'organisation-registry-vlaanderenbe',
            'organisation-registry-zorgengezondheid',
          ]
    steps:
      - id: latest-release
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          owner: informatievlaanderen
          repo: organisation-registry
          excludes: prerelease, draft
      - name: debug_output
        shell: bash
        run: |
          echo ${{ steps.latest-release.outputs.release }}
      - id: get-version
        shell: bash
        env:
          VERSION: $GITHUB_REF
        run: |
          echo ::set-output name=VERSION::${steps.latest-release.outputs.release} | sed 's/v//'
      - name: CD
        env:
          BUILD_URL: ${{ secrets.VBR_AWS_BUILD_API }}/${{matrix.services}}
          STATUS_URL: ${{ secrets.VBR_AWS_BUILD_STATUS_API }}/${{matrix.services}}
        uses: informatievlaanderen/awscurl-polling-action@main
        with:
          environment: stg
          version: ${{ steps.get-version.outputs.VERSION }}
          status-url: $STATUS_URL
          deploy-url: $BUILD_URL
          access-key: ${{ secrets.VBR_AWS_BUILD_USER_ACCESS_KEY_ID }}
          secret-key: ${{ secrets.VBR_AWS_BUILD_USER_SECRET_ACCESS_KEY }}
          region: eu-west-1
          interval: 2
      - name: output
        shell: bash
        run: |
          echo build-uuid: ${{ steps.awscurl-polling-action.outputs.build-uuid }}
          echo Status: ${{ steps.awscurl-polling-action.outputs.status }}
          echo ${{ steps.awscurl-polling-action.outputs.final-message }}
